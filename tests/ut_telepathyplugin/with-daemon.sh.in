#! /bin/bash

set -m

tracker-control -rs > /dev/null

cleanup ()
{
  kill -INT $contactsd_pid
  kill -INT $ut_pid
  tracker-control -r > /dev/null
}
trap cleanup INT HUP TERM

# Start the unit test in background so it register the AM
"$@" &
ut_pid=$!

# FIXME: It is ugly to hardcode such path
/usr/lib/mission-control/mcclient6-wait-for-name "org.freedesktop.Telepathy.AccountManager"

# Start Contacts Daemon in background
export CONTACTSD_PLUGINS_DIRS=@PLUGINDIR@
@BINDIR@/contactsd &
contactsd_pid=$!

# Move unit test to front
e=0
fg %1
e=$?

trap - INT HUP TERM
cleanup

exit $e
