#!/bin/sh
#
# Configures to build the project
#

#-------------------------------------------------------------------------------
# script initialization
#-------------------------------------------------------------------------------

relpath=`dirname $0`
relpath=`(cd "$relpath"; /bin/pwd)`
outpath=`/bin/pwd`

PREFIX=/usr
LOCALSTATEDIR=/var

TOP_SOURCEDIR=$relpath
TOP_BUILDDIR=$outpath

while [ "$#" -gt 0 ]; do
    case "$1" in
    -h|--help)
        echo "Usage: ./configure [OPTION]..."
        echo
        echo "Configuration:"
        echo "    -h, --help              display this help and exit"
        echo
        echo "Installation directories:"
        echo "    --prefix PREFIX         install everything relative to PREFIX"
        echo "                            [/usr]"
        echo
        echo "Fine tuning of the installation directories:"
        echo "    --bindir=DIR            user executables [PREFIX/bin]"
        echo "    --libdir=DIR            object code libraries [PREFIX/lib]"
        echo "    --includedir=DIR        C header files [PREFIX/include]"
        echo "    --localstatedir=DIR     modifiable single-machine data [/var]"
        echo
        exit
        ;;
    --prefix)
        shift
        PREFIX=$1
        ;;
    --bindir)
        shift
        BINDIR=$1
        ;;
    --libdir)
        shift
        LIBDIR=$1
        ;;
    --includedir)
        shift
        INCLUDEDIR=$1
        ;;
    --localstatedir)
        shift
        LOCALSTATEDIR=$1
        ;;
    *)
        echo >&2 "configure: error: unrecognized option: '$1'"
        echo >&2 "Try './configure --help' for more information."
        exit
        ;;
    esac
    shift
done

[ -z $BINDIR ] && BINDIR=$PREFIX/bin
[ -z $LIBDIR ] && LIBDIR=$PREFIX/lib
[ -z $INCLUDEDIR ] && INCLUDEDIR=$PREFIX/include

# save configuration into .qmake.cache
CACHEFILE="$outpath/.qmake.cache"
[ -f "$CACHEFILE" ] && rm -f "$CACHEFILE"

cat >> "$CACHEFILE" << EOF
PREFIX = \$\$quote($PREFIX)
BINDIR = \$\$quote($BINDIR)
LIBDIR = \$\$quote($LIBDIR)
INCLUDEDIR = \$\$quote($INCLUDEDIR)
LOCALSTATEDIR = \$\$quote($LOCALSTATEDIR)
TOP_SOURCEDIR = \$\$quote($TOP_SOURCEDIR)
TOP_BUILDDIR = \$\$quote($TOP_BUILDDIR)
EOF

# pre-process .in files
cat $TOP_SOURCEDIR/contactsd-1.0.pc.in | sed -e "s,@PREFIX@,${PREFIX},g" \
    > $TOP_BUILDDIR/contactsd-1.0.pc

mkdir -p $TOP_BUILDDIR/tests/dbus-1
cat $TOP_SOURCEDIR/tests/dbus-1/session.conf.in | sed -e "s,@TOP_BUILDDIR@,${TOP_BUILDDIR},g" \
    > $TOP_BUILDDIR/tests/dbus-1/session.conf

# run qmake
qmake $relpath/contactsd.pro

echo "contactsd is now configure for building. Just run 'make'."
echo "Once everything is built, you must run 'make install'."
echo "contactsd will be installed into $PREFIX"
echo "To reconfigure, run 'make confclean' and 'configure'."
